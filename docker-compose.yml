# ========================================
# Smart Factory IoT Backend - Local Development
# ========================================
# This file orchestrates the microservices for local development.
# Features:
# - Local PostgreSQL with persistence
# - Service health checks
# - Environment variable configuration
# - Network isolation
# ========================================

version: '3.8'

services:
  # ----------------------------------------
  # RabbitMQ (Event Bus + MQTT endpoint)
  # ----------------------------------------
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: sf-rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
      - "1883:1883"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    command: >
      sh -c "rabbitmq-plugins enable --offline rabbitmq_mqtt &&
             rabbitmq-server"
    networks:
      - sf-network

  # ----------------------------------------
  # Database Service
  # ----------------------------------------
  postgres:
    image: postgres:16
    container_name: sf-postgres
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgrespassword
      - POSTGRES_DB=SmartFactory
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deploy/local-dev/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d SmartFactory"]
      timeout: 5s
      retries: 10
    networks:
      - sf-network

  # ----------------------------------------
  # Device Service
  # ----------------------------------------
  device-service:
    build:
      context: .
      dockerfile: src/Services/DeviceService/Dockerfile
    container_name: sf-device-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=SmartFactory;Username=postgres;Password=postgrespassword;SSL Mode=Disable;Trust Server Certificate=true;
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "5001:80"
    networks:
      - sf-network

  # ----------------------------------------
  # Identity Service
  # ----------------------------------------
  identity-service:
    build:
      context: .
      dockerfile: src/Services/IdentityService/Dockerfile
    container_name: sf-identity-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=SmartFactory;Username=postgres;Password=postgrespassword;SSL Mode=Disable;Trust Server Certificate=true;
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "5002:80"
    networks:
      - sf-network

  # ----------------------------------------
  # Notification Service
  # ----------------------------------------
  notification-service:
    build:
      context: .
      dockerfile: src/Services/NotificationService/Dockerfile
    container_name: sf-notification-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - RabbitMqConnectionString=amqp://guest:guest@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_started
      postgres:
        condition: service_healthy
    ports:
      - "5003:80"
    networks:
      - sf-network

  # ----------------------------------------
  # Analytics Service
  # ----------------------------------------
  analytics-service:
    build:
      context: .
      dockerfile: src/Services/AnalyticsService/Dockerfile
    container_name: sf-analytics-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - RabbitMqConnectionString=amqp://guest:guest@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_started
      postgres:
        condition: service_healthy
    ports:
      - "5004:80"
    networks:
      - sf-network

  # ----------------------------------------
  # Telemetry Service
  # ----------------------------------------
  telemetry-service:
    build:
      context: .
      dockerfile: src/Services/TelemetryService/Dockerfile
    container_name: sf-telemetry-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=SmartFactory;Username=postgres;Password=postgrespassword;SSL Mode=Disable;Trust Server Certificate=true;
      - PostgresConnectionString=Host=postgres;Port=5432;Database=SmartFactory;Username=postgres;Password=postgrespassword;SSL Mode=Disable;Trust Server Certificate=true;
      - RabbitMqConnectionString=amqp://guest:guest@rabbitmq:5672
      - MqttBrokerHost=rabbitmq
      - MqttBrokerPort=1883
      - MqttTopic=smartfactory/telemetry
    depends_on:
      rabbitmq:
        condition: service_started
      postgres:
        condition: service_healthy
    ports:
      - "5005:80"
    networks:
      - sf-network

# ----------------------------------------
# Infrastructure Definitions
# ----------------------------------------
volumes:
  postgres_data:

networks:
  sf-network:
    driver: bridge
